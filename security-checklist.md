# src-check ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## âœ… ç¢ºèªæ¸ˆã¿é …ç›®

### 1. å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®æ’é™¤
- [x] `importlib.import_module` ã®ä½¿ç”¨ãªã—
- [x] `__import__` ã®ä½¿ç”¨ãªã—
- [x] `exec()` / `eval()` ã®ä½¿ç”¨ãªã—
- [x] DFSæ¢ç´¢ã«ã‚ˆã‚‹å‹•çš„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç™ºè¦‹ã‚’é™çš„ç™»éŒ²ã«å¤‰æ›´

### 2. è¦ä»¶å®šç¾©æ›¸ã®æ›´æ–°
- [x] å‹•çš„å“è³ªåˆ†æã‚·ã‚¹ãƒ†ãƒ  â†’ é™çš„å“è³ªåˆ†æã‚·ã‚¹ãƒ†ãƒ 
- [x] ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²åˆ¶ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰ã¸ã®ç§»è¡Œ
- [x] ASTè§£æã®ã¿ã«ã‚ˆã‚‹å®‰å…¨ãªå®Ÿè£…
- [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®å¼·åŒ–

### 3. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å®‰å…¨æ€§
- [x] ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œã‚’ä¼´ã‚ãªã„é™çš„è§£æ
- [x] ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ã‚ˆã‚‹æ˜ç¤ºçš„ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†
- [x] ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ä¸è¦ï¼ˆãã‚‚ãã‚‚å®Ÿè¡Œã—ãªã„ï¼‰

## âš ï¸ è¿½åŠ ã§ç¢ºèªãŒå¿…è¦ãªé …ç›®

### 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹
- [ ] ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã®é˜²æ­¢
- [ ] ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®é©åˆ‡ãªå‡¦ç†
- [ ] æ›¸ãè¾¼ã¿æ¨©é™ã®æœ€å°åŒ–

### 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
- [ ] YAML/JSONãƒ‘ãƒ¼ã‚µãƒ¼ã®å®‰å…¨ãªä½¿ç”¨
- [ ] è¨­å®šå€¤ã®é©åˆ‡ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ç’°å¢ƒå¤‰æ•°ã®å®‰å…¨ãªå–ã‚Šæ‰±ã„

### 3. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
- [ ] å¤–éƒ¨ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç½²åæ¤œè¨¼ï¼ˆå°†æ¥å®Ÿè£…ï¼‰
- [ ] ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ¨©é™åˆ¶é™
- [ ] æ‚ªæ„ã®ã‚ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®æ¤œå‡º

### 4. ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®åˆ¶é™
- [ ] CPUä½¿ç”¨ç‡ã®åˆ¶é™
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ã®ãƒªãƒ¼ã‚¯é˜²æ­¢

## ğŸ”’ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é…å¸ƒæ™‚ã®æ¨å¥¨äº‹é …

### 1. ä¾å­˜é–¢ä¿‚ã®ç®¡ç†
```toml
[project]
dependencies = [
    "pyyaml>=5.4",  # CVE-2020-14343 ä»¥é™ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
]
```

### 2. æœ€å°æ¨©é™ã®åŸå‰‡
- èª­ã¿å–ã‚Šå°‚ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆåˆ†ææ™‚ï¼‰
- æ›¸ãè¾¼ã¿ã¯æ˜ç¤ºçš„ã«æŒ‡å®šã•ã‚ŒãŸå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãªã—

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼
```python
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã®ä¾‹
SECURITY_POLICY = {
    "max_file_size": 10 * 1024 * 1024,  # 10MB
    "max_ast_depth": 1000,
    "allowed_file_extensions": [".py"],
    "forbidden_paths": ["/etc", "/sys", "/proc"],
}
```

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã«æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚ãªã„
- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®é©åˆ‡ãªã‚µãƒ‹ã‚¿ã‚¤ã‚º
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å°åŒ–

## ğŸ“‹ å®Ÿè£…æ™‚ã®æ³¨æ„äº‹é …

### 1. ASTè§£æã®åˆ¶é™
```python
def safe_parse_ast(file_path: Path, max_size: int = 10_000_000):
    """å®‰å…¨ãªASTè§£æ"""
    # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
    if file_path.stat().st_size > max_size:
        raise ValueError("File too large")
    
    # å®‰å…¨ãªèª­ã¿è¾¼ã¿
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read(max_size)
    
    # ASTè§£æï¼ˆå®Ÿè¡Œãªã—ï¼‰
    return ast.parse(content, filename=str(file_path))
```

### 2. ãƒ‘ã‚¹æ¤œè¨¼
```python
def validate_path(path: Path, base_dir: Path) -> Path:
    """ãƒ‘ã‚¹ã®å®‰å…¨æ€§ã‚’æ¤œè¨¼"""
    resolved = path.resolve()
    base_resolved = base_dir.resolve()
    
    # ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«é˜²æ­¢
    if not str(resolved).startswith(str(base_resolved)):
        raise ValueError("Path traversal detected")
    
    return resolved
```

### 3. ãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ¤œè¨¼
```python
def validate_plugin(plugin_class):
    """ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å®‰å…¨æ€§ã‚’æ¤œè¨¼"""
    # BaseCheckerã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ã‹
    if not issubclass(plugin_class, BaseChecker):
        raise TypeError("Invalid plugin type")
    
    # å±é™ºãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã„ãªã„ã‹
    forbidden_methods = ['__del__', '__setattr__', '__delattr__']
    for method in forbidden_methods:
        if method in plugin_class.__dict__:
            raise SecurityError(f"Plugin overrides forbidden method: {method}")
```

## âœ… çµè«–

ç¾åœ¨ã®è¦ä»¶å®šç¾©æ›¸ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç§»è¡Œè¨ˆç”»ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒé”æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®å®Œå…¨æ’é™¤** - é™çš„è§£æã®ã¿
2. **å®‰å…¨ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ** - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆåˆ¶
3. **äºˆæ¸¬å¯èƒ½ãªå‹•ä½œ** - æ˜ç¤ºçš„ã«ç™»éŒ²ã•ã‚ŒãŸãƒã‚§ãƒƒã‚«ãƒ¼ã®ã¿
4. **ç›£æŸ»å¯èƒ½æ€§** - å…¨ã¦ã®å‹•ä½œãŒè¿½è·¡å¯èƒ½

ã“ã‚Œã«ã‚ˆã‚Šã€pipãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦å®‰å…¨ã«é…å¸ƒã§ãã‚‹è¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚