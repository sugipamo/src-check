# コード品質改善と自動修正計画

実施予定日時: 2025-07-02 15:32

## 概要

src-checkプロジェクトの基本機能は実装完了しているが、コード品質に関する多数の問題が検出されている。
本計画では、これらの問題を体系的に解決し、プロジェクトの品質基準を満たすようにする。

## 現状分析

### 検出された問題の概要
- **テストの失敗**: 1件 (test_circular_import_detection)
- **Blackフォーマット**: 26ファイルが非準拠
- **Ruffリンティング**: 620件のエラー（566件は自動修正可能）
- **mypy型チェック**: 67件のエラー
- **テストカバレッジ**: 81.81%（基準の70%は達成）

### 優先度別タスク

#### 高優先度（即座に対応）
1. **テスト失敗の修正**
   - ArchitectureChecker.checkメソッドの実装修正
   - 循環インポート検出ロジックの実装

2. **型スタブのインストール**
   - types-PyYAML
   - types-toml

#### 中優先度（自動化可能）
3. **コードフォーマット自動修正**
   - Blackによる自動フォーマット
   - Ruffによる自動修正（566件）

4. **手動修正が必要な型エラー**
   - CheckResultモデルの属性エラー
   - 関数の型アノテーション追加
   - 変数の型アノテーション追加

## 実装計画

### フェーズ1: 環境準備と自動修正（30分）

#### 1.1 型スタブのインストール
```bash
pip install types-PyYAML types-toml
```

#### 1.2 自動フォーマット実行
```bash
# Blackでコードフォーマット
black src/ tests/

# Ruffで自動修正可能なエラーを修正
ruff check --fix src/ tests/
```

#### 1.3 修正結果の確認
```bash
# 残りのエラーを確認
ruff check src/ tests/
mypy src/
```

### フェーズ2: テスト失敗の修正（1時間）

#### 2.1 失敗原因の詳細調査
```bash
# 詳細なエラー情報を取得
pytest tests/unit/test_checkers.py::TestArchitectureChecker::test_circular_import_detection -vvs
```

#### 2.2 ArchitectureCheckerの実装確認
- src/src_check/rules/architecture.pyの実装を確認
- checkメソッドの戻り値がNoneになっている原因を特定
- 循環インポート検出ロジックの実装

#### 2.3 テストの再実行と確認
```bash
# 修正後のテスト実行
pytest tests/unit/test_checkers.py::TestArchitectureChecker -v
```

### フェーズ3: 型エラーの手動修正（1時間）

#### 3.1 CheckResultモデルの修正
- 必要な属性（line, message, rule_id等）の追加
- 既存の使用箇所との整合性確認

#### 3.2 型アノテーションの追加
優先順位：
1. パブリックAPI（外部から呼ばれる関数）
2. 複雑なロジックを持つ関数
3. エラーが多い箇所

#### 3.3 mypyの再実行
```bash
# 段階的に修正を確認
mypy src/src_check/models/
mypy src/src_check/core/
mypy src/src_check/
```

### フェーズ4: 残存エラーの対処（30分）

#### 4.1 Ruffの手動修正項目
- インポート順序の整理
- 未使用インポートの削除
- その他のスタイルエラー

#### 4.2 最終確認
```bash
# 全体的な品質チェック
make test
make lint
make type-check
```

## 成功指標

- [ ] 全てのテストがパス（37/37）
- [ ] Blackフォーマット準拠（0エラー）
- [ ] Ruffエラー数を100件以下に削減
- [ ] mypy型エラーを20件以下に削減
- [ ] CI/CDパイプラインが正常に通過

## 推定所要時間

- フェーズ1: 30分（自動化中心）
- フェーズ2: 1時間（テスト修正）
- フェーズ3: 1時間（型エラー修正）
- フェーズ4: 30分（最終調整）
- **合計: 約3時間**

## リスクと対策

### リスク1: 自動修正による予期しない変更
- 対策: Gitで変更を確認し、問題があれば部分的にリバート

### リスク2: 型アノテーション追加による既存コードの破壊
- 対策: 段階的に修正し、都度テストを実行

### リスク3: 時間超過
- 対策: 優先度の低いエラーは次のイテレーションに持ち越し

## 次のステップ

1. この計画に従って品質改善を実施
2. 改善後、追加チェッカーの実装に着手
3. v0.1.0のリリース準備